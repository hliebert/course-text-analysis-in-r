Econometrica, Vol. 86, No. 6 (November, 2018), 1911‚Äì1938

THE SORTED EFFECTS METHOD: DISCOVERING HETEROGENEOUS
EFFECTS BEYOND THEIR AVERAGES
VICTOR CHERNOZHUKOV
Department of Economics, MIT
IV√ÅN FERN√ÅNDEZ-VAL
Department of Economics, BU
YE LUO
Faculty of Business and Economics, The University of Hong Kong
The partial (ceteris paribus) effects of interest in nonlinear and interactive linear
models are heterogeneous as they can vary dramatically with the underlying observed
or unobserved covariates. Despite the apparent importance of heterogeneity, a common practice in modern empirical work is to largely ignore it by reporting average partial effects (or, at best, average effects for some groups). While average effects provide
very convenient scalar summaries of typical effects, by definition they fail to reflect
the entire variety of the heterogeneous effects. In order to discover these effects much
more fully, we propose to estimate and report sorted effects‚Äîa collection of estimated
partial effects sorted in increasing order and indexed by percentiles. By construction,
the sorted effect curves completely represent and help visualize the range of the heterogeneous effects in one plot. They are as convenient and easy to report in practice
as the conventional average partial effects. They also serve as a basis for classification
analysis, where we divide the observational units into most or least affected groups and
summarize their characteristics. We provide a quantification of uncertainty (standard
errors and confidence bands) for the estimated sorted effects and related classification
analysis, and provide confidence sets for the most and least affected groups. The derived statistical results rely on establishing key, new mathematical results on Hadamard
differentiability of a multivariate sorting operator and a related classification operator,
which are of independent interest.
We apply the sorted effects method and classification analysis to demonstrate several
striking patterns in the gender wage gap. We find that this gap is particularly strong for
married women, ranging from ‚àí60% to 0% between the 2% and 98% percentiles, as
a function of observed and unobserved characteristics; while the gap for never married
women ranges from ‚àí40% to +20%. The most adversely affected women tend to be
married, do not have college degrees, work in sales, and have high levels of potential
experience.
KEYWORDS: Sorting, partial effect, marginal effect, sorted effect, classification analysis, nonlinear model, functional analysis, differential geometry, gender wage gap.

Victor Chernozhukov: vchern@mit.edu
Iv√°n Fern√°ndez-Val: ivanf@bu.edu
Ye Luo: kurtluo@hku.hk
We thank the coeditor, three anonymous referees, Alberto Abadie, Daron Acemoglu, Isaiah Andrews,
Joshua Angrist, Debopam Bhattacharya, Jaroslav Borovicka, Kasey Buckles, Denis Chetverikov, Jerry Hausman, Tetsuya Kaji, Pat Kline, Roger Koenker, Siyi Luo, Maddie McKelway, Anna Mikusheva, Whitney Newey,
Claudia Olivetti, Andres Santos, Camille Terrier, Frank Windmeijer, Abigail Wozniak, and seminar participants at multiple institutions for helpful discussions. We gratefully acknowledge research support from the
National Science Foundation.
¬© 2018 The Econometric Society

https://doi.org/10.3982/ECTA14415

1912

V. CHERNOZHUKOV, I. FERN√ÅNDEZ-VAL, AND Y. LUO

1. INTRODUCTION
IN NONLINEAR AND INTERACTIVE LINEAR MODELS, the partial (ceteris paribus) effects
of interest often vary with respect to the underlying covariates. For example, consider
a binary response model with conditional choice probability P(Y = 1 | X) = F(X T Œ≤),
where Y is a binary response variable, X is a vector of covariates, F is a distribution
function such as the standard normal or logistic, and Œ≤ is a vector of coefficients. The
partial or predictive effect (PE) of a marginal change in a continuous covariate Xj with
coefficient Œ≤j on the conditional choice probability is
(X) = f (X T Œ≤)Œ≤j 

f (v) = ‚àÇF(v)/‚àÇv

which generally varies in the population of interest with the covariate vector X, as X
varies according to some distribution, say Œº. A common empirical practice is to report
the average partial effect (APE),



E (X) = (x) dŒº(x)
as a single summary measure of the PE (e.g., Wooldridge (2010), Chapter 2), or to report
effects for some groups (e.g., Angrist and Pischke (2008)). However, the APE completely
disregards the heterogeneity of the PE and may give a very incomplete picture of the
impact of the covariates.
In this paper, we propose complementing the APE by reporting the entire set of PEs
sorted in increasing order and indexed by a ranking with respect to the distribution of the
covariates in the population of interest. These sorted effects correspond to percentiles of
the PE,
‚àóŒº (u) = uth-quantile of (X)

X ‚àº Œº

and provide a more complete representation of the heterogeneity of (X). We shall call
these effects as sorted predictive or partial effects (SPE) by default, as most models are
predictive.1 We also show how to use the SPEs to carry out classifications analysis (CA).
This analysis consists of classifying the observational units into most or least affected
depending on whether their PEs are above or below some tail SPE, and then comparing
the moments or distribution of the covariates of the most and least affected groups.
Heterogeneous effects also arise in the most basic linear models with interactions (Oaxaca (1973), Cox (1984)). Consider a conditional mean model for the Mincer earnings
function:
Y = P(T W )T Œ≤ + 

E[ | T W ] = 0

X = (T W )

where Y is log wage, T is an indicator of gender (or race, treatment, or program participation), and W is a vector of labor market characteristics. The vector P(T W ) is a
collection of transformations of T and W , involving some interaction between T and W .
For example, Oaxaca (1973) used the specification P(T W ) = (T W  (1 ‚àí T )W ). Then,
the PE of changing T = 0 to T = 1 is
(X) = P(1 W )T Œ≤ ‚àí P(0 W )T Œ≤
1
When the underlying model has a structural or causal interpretation, we may use the name sorted structural
effects or sorted treatment effects.

THE SORTED EFFECTS METHOD

1913

FIGURE 1.‚ÄîAPE and SPE (introduced in this paper) of the gender wage gap for women. Estimates and
90% bootstrap uniform confidence bands (derived in this paper) based on a linear model with interactions for
the conditional expectation (left) and quantile (right) functions.

which is a measure of the gender wage gap conditional on worker characteristics. The
function u ‚Üí ‚àóŒº (u) provides again a complete summary of the entire range of PEs. The
left panel of Figure 1 illustrates the SPE of the conditional gender wage gap for women.
The SPE varies sharply from around ‚àí40 to 65%, and does not coincide with the average
PE of ‚àí20%. The PE is especially (negatively) large for women who have any of the
following characteristics: married, low educated, high experience, and working on sales
occupations; this follows from the classification analysis, where we compare the average
characteristics of the subpopulations of women with covariate values X such that (X) is
above the 90% percentile and below the 10% percentile. We refer the reader to Section 3
for a detailed discussion of this example.
The general settings that we deal with in this paper as well as the specific results we obtain are as follows: Let X denote a covariate vector, (X) denote a generic PE of interest,
Œº denote the distribution of X in the population of interest, and X denote the interior
of the support of X in this population. The SPE is obtained by sorting the multivariate
function x ‚Üí (x) in increasing order with respect to Œº. Using tools from differential geometry, we prove that this multivariate sorting operator is Hadamard differentiable with
respect to the PE function  and the distribution Œº at the regular values of x ‚Üí (x) on
X . This key and new mathematical result allows us to derive the large sample properties
of the empirical SPE, which replace  and Œº by sample analogs, obtained from parametric or semiparametric estimators, using the functional delta method. In particular, we
derive a functional central limit theorem and a bootstrap functional central limit theorem
for the empirical SPE. The main requirement of these theorems is that the empirical 
and Œº also satisfy functional central limit theorems, which hold for many estimators used
in empirical economics under general sampling conditions. We use the properties of the
empirical SPE to construct confidence sets for the SPE that hold uniformly over quantile
indices. We also show under the same conditions that the empirical version of the objects in the classification analysis follow functional central limit theorems and bootstrap
functional central limit theorems. We derive these results by establishing the Hadamard
differentiability of a classification operator related to the multivariate sorting operator.

1914

V. CHERNOZHUKOV, I. FERN√ÅNDEZ-VAL, AND Y. LUO

Related Technical Literature. Previously, Chernozhukov, Fern√°ndez-Val, and Galichon
(2010) derived the properties of the rearrangement (sorting) operator in the univariate
case with known Œº (standard uniform distribution). Those results were motivated by a
completely different problem‚Äînamely, restoration of monotonicity in conditional quantile estimation‚Äîrather than the problem of summarizing heterogeneous effects by the
SPEs. These prior technical results are not applicable to our case as soon as the dimension of X is greater than 1, which is the case in all modern applications where effects are
of interest. Moreover, the previous results are not applicable even in the univariate case
since the measure Œº is not known in all envisioned applications. The properties of the
sorting operator are different in the multivariate case and require tools from differential
geometry: computation of functional (Hadamard) derivatives of the sorting operator with
respect to perturbations of  require us to work with integration on (dx ‚àí 1)-dimensional
manifolds of the type {(x) = Œ¥}, where dx = dim X. Moreover, we also need to compute functional derivatives with respect to suitable perturbations of the measure Œº. In
econometrics or statistics, Sasaki (2015) also used differential geometry to characterize
the structural properties of derivatives of conditional quantile functions in nonseparable
models; and Kim and Pollard (1990) used tools from differential geometry to derive the
large sample properties of the maximum score and other cube root consistent estimators. Relative to these papers, we share the use of differential geometry tools as a general
proof strategy, but we apply these tools to establish the analytical properties of different
functionals‚Äînamely, the SPEs. Moreover, our results on the functional differentiability
of the sorting and classification operators in the multivariate case constitute new mathematical results, which are of interest in their own right.
Organization of the Paper. In Section 2, we discuss the quantities of interest in nonlinear
and interactive linear models with examples; introduce the SPE and related CA, along
with their empirical counterparts; and outline the main inferential results. In Section 3,
we provide an empirical application to the gender wage gap in the United States in 2015.
We derive the properties of the empirical SPE and CA in large samples and show how to
use these properties to make inference in Section 4. Appendix A provides some key mathematical results on the differentiability of the multivariate sorting and classification operators and Appendix B contains the proof of the main results. All other proofs are given in
the Supplemental Material (Chernozhukov, Fernandez-Val, and Luo (2018)), which also
contains additional technical material, and results from Monte Carlo simulations and an
empirical application to mortgage denials using binary response models.
2. SORTED EFFECTS AND CLASSIFICATION ANALYSIS
We start by discussing the objects of interest in nonlinear and interactive linear models.
2.1. Effects of Interest
We consider a general model characterized by a predictive function g(X), where X
is a dx -vector of covariates that may contain unobserved components, as in quantile regression models. The function g usually arises from a model for a response variable Y ,
which can be discrete or continuous. We call the function g predictive because the underlying model can be either predictive or causal under additional assumptions, but we do
not insist on estimands having a causal interpretation. For example, in a mean regression
model, g(X) = E[Y | X] corresponds to the expectation function of Y conditional on X;
in a binary response model, g(X) = P[Y = 1 | X] corresponds to the choice probability

THE SORTED EFFECTS METHOD

1915

of Y = 1 conditional on X; in a quantile regression model, g(X) = QY [ | Z], where the
covariate X = ( Z) consists of the unobservable rank variable  with a uniform distribution,  | Z ‚àº U(0 1), and the observed covariate vector Z, and where QY [œÑ | Z] is the
conditional œÑth-quantile of Y given Z.
Let X = (T W ), where T is the key covariate or treatment of interest, and W is a vector
of control variables. We are interested in the effects of changes in T on the function g
holding W constant. These effects are usually called partial effects, marginal effects, or
treatment effects. We call them predictive effects (PE) throughout the paper, as such a
name most accurately describes the meaning of the estimand (especially when a causal
interpretation is not available). If T is discrete, the PE is
(x) = (t w) = g(t1  w) ‚àí g(t0  w)

(2.1)

where t1 and t0 are two values of T that might depend on t (e.g., t0 = 0 and t1 = 1, or
t0 = t and t1 = t + 1). This PE measures the effect of changing T from t0 to t1 holding W
constant at w. If T is continuous and t ‚Üí g(t w) is differentiable, the PE is
(x) = (t w) = ‚àÇt g(t w)

(2.2)

where ‚àÇt denotes ‚àÇ/‚àÇt, the partial derivative with respect to t. This PE measures the effect
of a marginal change of T from the level t holding W constant at w.2
We consider the following examples in the empirical applications of Section 3 and Supplemental Material.
EXAMPLE 1‚ÄîBinary Response Model: Let Y be a binary response variable such as an
indicator for mortgage denial, and X be a vector of covariates related to Y . The predictive
function of the probit or logit model takes the form


g(X) = P(Y = 1 | X) = F P(X)T Œ≤ 
where P(X) is a vector of known transformations of X, Œ≤ is a parameter vector, and F
is a known distribution function (the standard normal distribution function in the probit
model or standard logistic distribution function in the logit model). If T is a binary variable such as an indicator for black applicant and W is a vector of controls such as the
applicant characteristics relevant for the bank decision, the PE,




(x) = F P(1 w)T Œ≤ ‚àí F P(0 w)T Œ≤ 
describes the difference in predicted probability of mortgage denial for a black applicant
and a white applicant, conditional on a specific value w of the observable characteristics W .
EXAMPLE 2‚ÄîInteractive Linear Model With Additive Error: Let Y be the logarithm
of the wage. Suppose X = (T W ), where T is an indicator for female worker and W are
2
We can also consider high-order and crossed effects. For example, (x) = ‚àÇ2t 2 g(t w) gives the second-order
PE of the continuous treatment T if t ‚Üí g(t w) is twice differentiable; and, letting X = (T S W ) where T and
S are discrete, (x) = g(t1  s1  w)‚àíg(t0  s1  w)‚àíg(t1  s0  w)+g(t0  s0  w) gives the crossed effect or interaction
of T and S.

1916

V. CHERNOZHUKOV, I. FERN√ÅNDEZ-VAL, AND Y. LUO

other worker characteristics. We can model the conditional expectation function of log
wage using the linear interactive model:
Y = g(X) +  = P(T W )T Œ≤ + 

E[ | T W ] = 0

X = (T W )

where P(T W ) is a collection of transformations of T and W , involving some interaction
between T and W . For example, P(T W ) = (T W  (1 ‚àí T )W ). Then the PE
(x) = P(1 w)T Œ≤ ‚àí P(0 w)T Œ≤
is the (average) gender wage gap or difference between the expected log wage of a woman
and a man, conditional on a specific value w of the characteristics W .
EXAMPLE 3‚ÄîLinear Model With Non-Additive Error, or QR Model: Let Y be log
wage, T be an indicator for female worker, and W be a vector of worker characteristics as
in the previous example. Suppose we model the conditional quantile function of log wage
using the linear interactive model:
Y = g(X) = P(T W )T Œ≤()

 | T W ‚àº U(0 1)

X = (T W  )

where P(T W )T Œ≤(œÑ) is the conditional œÑth-quantile of Y given T and W . Thus the covariate vector X = (T W  ) includes the observed covariates (T W ) as well as the rank
variable , which is an unobserved factor (e.g., ‚Äúability rank‚Äù). Here P(T W ) is a collection of transformations of T and W , for example, P(T W ) = (T W  (1 ‚àí T )W ). Then the
PE,
(x) = P(1 w)T Œ≤(œÑ) ‚àí P(0 w)T Œ≤(œÑ)

x = (t w œÑ)

is the (œÑth-quantile) gender wage gap or difference between the conditional œÑth-quantile
of log wage of a woman and a man, conditional on a specific value w of the characteristics W .
Note that in this case,
X ‚àº Œº

Œº = FTW √ó F 

where F is the distribution function of the standard uniform random variable, and FTW
is the distribution of (T W ). For estimation purposes, we will have to exclude the tail
quantile indices, so F will be redefined to have support on a set of the form [  1 ‚àí ],
where 0 < < 05 is a small positive number.
The set of examples listed above are the most basic, leading cases, arising mostly in
predictive analysis and program evaluation. Our theoretical results are rather general
and are not limited to these cases. Thus, they allow for both  and Œº to originate from
causal or structural models and to be estimated by structural methods. For example, in
treatment effects models with selection on observables (Rosenbaum and Rubin (1983)),
the PE is the conditional average treatment effect (x) = E(Y1 ‚àí Y0 | X = x), where Y1
and Y0 are potential outcomes in the treated and non-treated statuses and X is a vector
of covariates. The standard approach is to aggregate the conditional average treatment
effects by integration with respect to the distribution of the covariates in the population
of interest Œº. This yields the average treatment effect if Œº is the distribution in the entire population or the average treatment effect on the treated if Œº is the distribution in
the treated subpopulation. The SPE can be used to complement the analysis by reporting

THE SORTED EFFECTS METHOD

1917

the entire range of conditional average treatment effects, and also to determine the optimal treatment allocation with budget constraints. Thus, Bhattacharya and Dupas (2012)
showed that, under some conditions, this optimal allocation has a cutoff determined by
a tail percentile of the conditional average treatment effects, that is, by a SPE. Another
example is the welfare analysis described in Hausman and Newey (2017), where (x) is
the compensating or equivalent variation of a price change conditional on covariates such
as income and demographic characteristics, and Œº is the distribution of covariates in the
population of interest.
In all the previous examples, the PE (x) is a function of x and therefore can be different for each observational unit. To summarize this effect in a single measure, a common
practice in empirical economics is to average the PEs. Averaging, however, masks most
of the heterogeneity in the PE allowed by nonlinear or interactive linear models. We propose reporting the entire set of values of the PE sorted in increasing order and indexed by
a ranking u ‚àà [0 1] with respect to the population of interest. These sorted effects provide
a more complete representation of the heterogeneity in the PE than the average effects.
DEFINITION 2.1‚Äîu-SPE: The uth-sorted predictive effect with respect to Œº is


 

‚àóŒº (u) := inf Œ¥ ‚àà R : FŒº (Œ¥) ‚â• u 
FŒº (Œ¥) := EŒº 1 (X) ‚â§ Œ¥ 
where EŒº denotes expectation with respect to Œº.
The u-SPE is the uth-quantile of (X) when X is distributed according to Œº. As for
the average effect, Œº can be chosen to select a target subpopulation from the entire population. For example, when T is a treatment indicator:
‚Ä¢ If Œº is set to the marginal distribution of X in the entire population, then ‚àóŒº (u) is
the population u-SPE.
‚Ä¢ If Œº is set to the distribution of X conditional on T = 1, then ‚àóŒº (u) is the u-SPE
on the treated or exposed.
By considering ‚àóŒº (u) at multiple quantile indices, we obtain a one-dimensional representation of the heterogeneity of the PE. Accordingly, our object of interest is the SPEfunction


u ‚Üí ‚àóŒº (u) : u ‚àà U  U ‚äÜ [0 1]
where U is the set of quantile indices of interest.
We also show how to use the u-SPE for classification analysis. Let u ‚àà U , with u < 1/2,
and Z be a dz -dimensional random vector that includes X and possibly other variables
such as Y in Examples 1‚Äì3. By abuse of notation, we also denote the distribution of Z
over its support Z as Œº.
DEFINITION 2.2‚Äîu-CA: The uth-classification analysis consists of two steps: (i) Assign all Z with (X) < ‚àóŒº (u) to the u-least affected subpopulation, and all Z with
(X) > ‚àóŒº (1 ‚àí u) to the u-most affected subpopulation. (ii) Obtain the moments and distribution of Z in the least and most affected subpopulations. We denote by Œõ‚àíu
Œº (t) and
+u
dz
ŒõŒº (t) generic objects indexed by t ‚àà R in the least and most affected subpopulations,
t
‚àó
respectively. For example, Œõ‚àíu
Œº (t) = EŒº [Z | (X) < Œº (u)] corresponds to the t-moment
‚àíu
of Z in the u-least affected subpopulation, and ŒõŒº (t) = EŒº [1(Z ‚â§ t) | (X) < ‚àóŒº (u)] to

1918

V. CHERNOZHUKOV, I. FERN√ÅNDEZ-VAL, AND Y. LUO

the distribution of Z at t in the u-least affected subpopulation.3 We define the same quantities in the u-most affected subpopulation replacing (X) < ‚àóŒº (u) by (X) > ‚àóŒº (1 ‚àí u)
in the conditioning set.
2.2. Empirical SPE
In practice, we replace the PE  and the distribution Œº by sample analogs to construct
plug-in estimators of the SPE. Let (x) and Œº(x) be estimators of (x) and Œº(x) obtained from {(Yi  Ti  Wi ) : 1 ‚â§ i ‚â§ n}, an independent and identically distributed sample
of size n from (Y T W ).
DEFINITION 2.3‚ÄîEmpirical u-SPE: The estimator of ‚àóŒº is


‚àóŒº (u) := ‚àóŒº (u) = inf Œ¥ ‚àà R : FŒº (Œ¥) ‚â• u 

 

FŒº (Œ¥) = EŒº 1 (X) ‚â§ Œ¥ =: FŒº (Œ¥)

Then the empirical SPE-function is


u ‚Üí ‚àóŒº (u) : u ‚àà U 

U ‚äÜ [0 1]

where U is the set of indices of interest that typically excludes tail indices and satisfies
other technical conditions stated in Section 4.
EXAMPLE 1‚ÄîBinary Response Model, cont.: The estimator of the PE is




(x) = F P(1 w)T Œ≤ ‚àí F P(0 w)T Œ≤ 
where Œ≤ is the maximum likelihood (ML) estimator of Œ≤,







Yi log F P(Ti  Wi )T b + (1 ‚àí Yi ) log 1 ‚àí F P(Ti  Wi )T b 

n

Œ≤ ‚àà arg max
b‚ààRdp

i=1

dp = dim P(T W )
EXAMPLE 2‚ÄîInteractive Linear Model With Additive Error, cont.: The estimator of
the PE is
(x) = P(1 w)T Œ≤ ‚àí P(0 w)T Œ≤
where Œ≤ is the ordinary least squares (OLS) estimator of Œ≤,
n

Œ≤ ‚àà arg min

b‚ààRdp



2
Yi ‚àí P(Ti  Wi )T b 

dp = dim P(T W )

i=1

EXAMPLE 3‚ÄîLinear Model With Non-Additive Error, cont.: The estimator of the PE
is
(x) = P(1 w)T Œ≤(œÑ) ‚àí P(0 w)T Œ≤(œÑ)
3

For a dz -dimensional random variable Z = (Z1      Zdz ) and t = (t1      tdz ) ‚àà Rdz , we denote Z t :=
t
Zjj and {Z ‚â§ t} := {Z1 ‚â§ t1      Zdz ‚â§ tdz }.

dz
j=1

THE SORTED EFFECTS METHOD

1919

where Œ≤(œÑ) is the Koenker and Basset (1978) quantile regression (QR) estimator of Œ≤(œÑ),
n

Œ≤(œÑ) ‚àà arg min
b‚ààR

dp



œÅœÑ Yi ‚àí P(Ti  Wi )T b 

i=1

dp = dim P(T W )



œÅœÑ (v) = œÑ ‚àí 1{v < 0} v

REMARK 2.1‚ÄîEstimation of Œº: Let S denote the indicator for an observational unit
belonging to the subpopulation of interest. For example, if S = T , then S = 1 indicates
the unit is in the subpopulation of the treated and S = 0 indicates the unit is in the subpopulation of the untreated. The indicator S can also incorporate other restrictions; for
example, S = 1{X ‚àà X } restricts the support of covariate X to the region X . Finally, if S
is always 1, then this means that we work with the entire population. Estimation of Œº can
be done using the empirical distribution:


n

n

Si 1{Xi ‚â§ x}

Œº(x) =
i=1

Si 
i=1

n
provided that i=1 Si > 0. An alternative would be to use the smoothed empirical distribution.
If Œº can be decomposed into known and unknown parts, then we only need to estimate
the unknown parts. Thus, Œº = FTW √ó F in Example 3, where F is known to be the uniform distribution and FTW is unknown, but can be estimated by the empirical distribution
of (T W ) in the part of the population of interest.
2.3. Empirical CA
The empirical version of the u-CA classifies the observations in the sample using the
empirical PEs and u-SPE, and computes the moments and distributions in the resulting
most and least affected subsamples.
DEFINITION 2.4‚ÄîEmpirical u-CA: The empirical uth-classification analysis consists
of two steps: (1) Assign all Zi with (Xi ) < ‚àóŒº (u) to the u-least affected subsample,
and all Zi with (Xi ) > ‚àóŒº (1 ‚àí u) to the u-most affected subsample. (2) Estimate the
moments and distribution of Z in the least and most affected subpopulations by the
‚àíu
empirical analogs in the least and most affected subsamples, that is, Œõ‚àíu
Œº (t) = ŒõŒº (t)
+u
‚àíu
t
‚àó
and Œõ+u
Œº (t) = ŒõŒº (t). For example, ŒõŒº (t) = EŒº [Z | (X) < Œº (u)] estimates the t-

moment of Z in the u-least affected subpopulation and Œõ‚àíu
Œº (t) = EŒº [1(Z ‚â§ t) | (X) <
‚àó
Œº (u)] the distribution of Z at t in the u-least affected subpopulation. The corresponding
estimators in the u-most affected subpopulation are constructed replacing (X) < ‚àóŒº (u)
by (X) > ‚àóŒº (1 ‚àí u) in the conditioning set. Here we use the same notation as in Definition 2.2.
2.4. Inference on SPE
The main inferential result for the SPE can be previewed as follows. Assume that the
PE function x ‚Üí (X) is not locally flat in the sense that the norm of its gradient does

1920

V. CHERNOZHUKOV, I. FERN√ÅNDEZ-VAL, AND Y. LUO

not vanish anywhere over the support,
‚àö and other regularity conditions stated in Section 4.
Then, the empirical SPE-process is n-consistent and converges in distribution to a centered Gaussian process, namely,

‚àö  ‚àó
n Œº (u) ‚àí ‚àóŒº (u)  Z‚àû (u) in ‚àû (U )
the metric space of bounded functions on U , as a stochastic process indexed by u ‚àà U ,
where U is a compact subset of (0 1). Moreover, the exchangeable bootstrap algorithm
specified in Algorithm 2.1 estimates consistently the law of Z‚àû (u).
The next corollary to Theorem 4.1 in Section 4 provides uniform bands that cover the
SPE-function simultaneously over a region of values of u with prespecified probability in
large samples. It does cover pointwise confidence bands for the SPE-function at a specific
quantile index u as a special case by simply taking U to be the singleton set {u}.
COROLLARY 2.1‚ÄîInference on SPE-Function Using Limit Theory and Bootstrap: Under the assumptions of Theorem 4.1, for any 0 < Œ± < 1,



‚àö
‚àö 
P ‚àóŒº (u) ‚àà ‚àóŒº (u) ‚àí t1‚àíŒ± (U )Œ£(u)1/2 / n ‚àóŒº (u) + t1‚àíŒ± (U )Œ£(u)1/2 / n : u ‚àà U ‚Üí 1 ‚àí Œ±
where t1‚àíŒ± (U ) is any consistent estimator of t1‚àíŒ± (U ), the (1 ‚àí Œ±)-quantile of


t(U ) := supZ‚àû (u)Œ£(u)‚àí1/2 
u‚ààU

and u ‚Üí Œ£(u) is a uniformly consistent estimator of u ‚Üí Œ£(u), the variance function of
u ‚Üí Z‚àû (u). We provide consistent estimators of t1‚àíŒ± (U ) and u ‚Üí Œ£(u) in Algorithm 2.1.
We now describe a practical bootstrap algorithm to estimate the quantiles of t(U ). Let
(œâ1      œân ) denote the bootstrap weights, which are nonnegative random variables independent of the data obeying the conditions stated in van der Vaart and Wellner (1996).
For example, (œâ1      œân ) is a multinomial vector with dimension n and probabilities
(1/n     1/n) in the empirical bootstrap. In what follows, B is the number of bootstrap
draws, such that B ‚Üí ‚àû. In our experience, setting B ‚â• 500 suffices for good accuracy.
ALGORITHM 2.1‚ÄîBootstrap Law of t(U ) and its Quantiles: (1) Draw a realization of
‚àó (u) = 
‚àóŒº (u), a bootthe bootstrap weights (œâ1      œân ). (2) For each u ‚àà U , compute 
Œº
‚àó
‚àó
 and 
Œº are the bootstrap versions of  and Œº that use
strap draw of Œº (u) = Œº (u), where 
(œâ1      œân ) as sampling weights in the computation of the estimators. Construct a bootstrap
‚àö ‚àó
‚àó
‚àû (u) = n(
draw of Z‚àû (u) as Z
Œº (u) ‚àí Œº (u)). (3) Repeat steps (1)‚Äì(2) B times. (4) For
each u ‚àà U , compute a bootstrap estimator of Œ£(u)1/2 such as the bootstrap interquartile
range rescaled with the normal distribution, Œ£(u)1/2 = (q075 (u) ‚àí q025 (u))/(z075 ‚àí z025 ),
‚àû (u) in the B draws and zp is the pth quanwhere qp (u) is the pth sample quantile of Z
‚àû (u)|Œ£(u)‚àí1/2 across
tile of N(0 1). (5) Use the empirical distribution of 
t(U ) = supu‚ààU |Z
the B draws to approximate the distribution of t(U ) = supu‚ààU |Z‚àû (u)|Œ£(u)‚àí1/2 . In particular,
construct t1‚àíŒ± (U ), an estimator of t1‚àíŒ± (U ), as the (1 ‚àí Œ±)-quantile of the B draws of 
t(U ).
REMARK 2.2‚ÄîMonotonization of the Bands: While the SPE-function u ‚Üí ‚àóŒº (u)
is increasing by definition, the end functions of the confidence band u ‚Üí ‚àóŒº (u) ¬±
‚àö
t1‚àíŒ± (U )Œ£(u)1/2 / n might not be increasing. Chernozhukov, Fern√°ndez-Val, and Galichon

THE SORTED EFFECTS METHOD

1921

(2009) showed that monotonizing the end functions via rearrangement reduces the width
of the band in uniform norm, while it increases coverage in finite samples. We use this
refinement in the empirical examples.4
REMARK 2.3‚ÄîFinite-Sample Bias Corrections: The empirical u-SPE might be biased
in small samples, especially at the tails. Bootstrap is also useful to improve the estimator
and confidence bands. Thus, a corrected estimator can be formed as 2‚àóŒº ‚àí ‚àóŒº , and a cor‚àö
rected (1 ‚àí Œ±)-confidence band as [2‚àóŒº ‚àí ‚àóŒº ¬± t1‚àíŒ± (U )Œ£(u)1/2 / n], where ‚àóŒº is the mean
of the bootstrap draw of the estimator. In Appendix H of the Supplemental Material, we
show that this correction reduces the bias of the estimator and increases the coverage of
the confidence bands in a simulation calibrated to the gender wage gap application.
2.5. Inference on CA
‚àíu
Œº

+u
Œº

+u
Let ŒõuŒº (t) := [Œõ (t) Œõ (t)] and ŒõuŒº (t) := [Œõ‚àíu
Œº (t) ŒõŒº (t)]. The main inferential result for CA can be previewed as follows: the empirical CA-process converges in
distribution to a centered bivariate Gaussian process, namely,

 2
‚àö  u
u
n ŒõŒº (t) ‚àí ŒõuŒº (t)  Z‚àû
(t) in ‚àû Rdz 
(2.3)

as a stochastic process indexed by t ‚àà Rdz . Moreover, exchangeable bootstrap estimates
u
consistently the law of Z‚àû
(t).
The next corollary to Theorem 4.2 in Section 4 provides uniform bands that cover L
linear combinations of the two-dimensional vector ŒõuŒº (t) with coefficients c1      cL simultaneously over t ‚àà T with prespecified probability in large samples. It covers pointwise confidence intervals for the mean of the kth component of Z for least affected as
a special case with L = 1 linear combination, c1 = (1 0) , and T = {ek }, where ek is a
unit vector with a one in the kth position. Joint confidence intervals for s differences
of means of the k1 th,     ks th components of Z between most and least affected are
a special case with L = 1 linear combination, c1 = (‚àí1 1) , and T = {ek1      eks }. Joint
uniform bands for the distribution of the kth component of Z for most and least affected are also a special case with L = 2 linear combinations, c1 = (1 0), c2 = (0 1), and
T = {t ‚àà Rdz : tj = TÃÑ  j = k}, where TÃÑ is an arbitrarily large number. By appropriate choice
of the linear combinations and the index set T , we can therefore conduct multiple tests
while preserving the significance level from simultaneous inference problems (Romano,
Shaikh, and Wolf (2010a,b), List, Shaikh, and Xu (2016)). We show examples in the empirical application of Section 3.
COROLLARY 2.2‚ÄîInference on CA-Function Using Limit Theory and Bootstrap: Under the assumptions of Theorem 4.2, for any 0 < Œ± < 1,



1/2 ‚àö
u
(T  L) c Œ£u (t)c
/ n : t ‚àà T  = 1     L ‚Üí 1 ‚àí Œ±
P c ŒõuŒº (t) ‚àà c ŒõuŒº (t) ¬± t1‚àíŒ±
u
u
(T  L) is any consistent estimator of t1‚àíŒ±
(T  L), the (1 ‚àí Œ±)-quantile of
where t1‚àíŒ±


‚àí1/2
u
(t) c Œ£u (t)c

t u (T  L) := sup c Z‚àû
t‚ààT  =1L

4

In practice, the rearrangement simply consists in sorting the two vectors containing the discretized version
of the end functions in increasing order; see Chernozhukov, Fern√°ndez-Val, and Galichon (2009) for more
details.

1922

V. CHERNOZHUKOV, I. FERN√ÅNDEZ-VAL, AND Y. LUO

and t ‚Üí Œ£u (t) is a uniformly consistent estimator of t ‚Üí Œ£u (t), the variance function of
u
(t). A p-value of the null hypothesis c ŒõuŒº (t) = r (t) for all t ‚àà T and = 1     L
t ‚Üí Z‚àû
of the realization of the statistic supt‚ààT  =1L |c ŒõuŒº (t) ‚àí r (t)|[c Œ£u (t)c ]‚àí1/2 = s is
u

St u (T L) (s) = P t1‚àíŒ±
(T  L) > s 
u
We provide consistent estimators of t1‚àíŒ±
(T  L), u ‚Üí Œ£u (t), and St u (T L) (t) in Algorithm 2.2.

ALGORITHM 2.2‚ÄîBootstrap Law of t(T  L), Quantiles, and p-Values: (1) Draw a real‚àíu (t) = Œõ‚àíu (t)
ization of the bootstrap weights (œâ1      œân ). (2) For each t ‚àà T , compute Œõ
Œº

Œº
+u
+u
‚àíu
‚àíu
+u

and Œõ (t) = Œõ (t), a bootstrap draw of Œõ (t) = Œõ (t) and Œõ (t) = Œõ+u (t),
Œº

Œº


Œº

Œº

Œº

Œº

where 
 and 
Œº are the bootstrap versions of  and Œº that use (œâ1      œân ) as samu
(t)
pling weights in the computation of the estimators. Construct a bootstrap draw of Z‚àû
‚àö u
‚àíu
+u
u
u
u




as Z‚àû (t) = n(ŒõŒº (t) ‚àí ŒõŒº (t)), where ŒõŒº (t) = [ŒõŒº (t) ŒõŒº (t)]. (3) Repeat steps
(1)‚Äì(2) B times. (4) For each t ‚àà T and = 1     L, compute a bootstrap estimator of
[c Œ£u (t)c ]1/2 such as the bootstrap interquartile range rescaled with the normal distribution
u
u
[c Œ£u (t)c ]1/2 = (q075
(t ) ‚àí q025
(t ))/(z075 ‚àí z025 ), where qpu (t ) is the pth sample quanu
 (t) in the B draws and zp is the pth quantile of N(0 1). (5) Use the empirical
tile of c Z
‚àû
u (t)|[c Œ£u (t)c ]‚àí1/2 across the B draws to apdistribution of 
t(T  L) = supt‚ààT  =1L |c Z
‚àû
u
proximate the distribution of t(T  L) = supt‚ààT  =1L |c Z‚àû
(t)|[c Œ£u (t)c ]‚àí1/2 . In particular,
construct t1‚àíŒ± (T  L), an estimator of t1‚àíŒ± (T  L), as the (1 ‚àí Œ±)-quantile of the B draws of

t(T  L), and an estimation of the p-value St u (T L) (s) as the proportion of the B draws of

t(T  L) that are greater than s.
2.6. Inference on Most and Least Affected Subpopulations
In addition to moments and distributions, we can conduct inference on the subpopulations of most and least affected.5 Let




M‚àíu := (x y) ‚àà Z : (x) ‚â§ ‚àóŒº (u) 
M+u := (x y) ‚àà Z : (x) ‚â• ‚àóŒº (1 ‚àí u)
be the sets representing the u-least and u-most affected subpopulation, respectively.
Here, we assume that Z is compact or that the support of (X Y ) has been intersected
with a compact set to form Z . We can construct an outer (1 ‚àí Œ±)-confidence set for M‚àíu
as6



‚àö 
CM‚àíu (1 ‚àí Œ±) = (x y) ‚àà Z : Œ£‚àí1/2 (x u) n (x) ‚àí ‚àóŒº (u) ‚â§ c(1 ‚àí Œ±) 
where c(1 ‚àí Œ±) is a consistent estimator of c(1 ‚àí Œ±), the (1 ‚àí Œ±)-quantile of the random
variable


V‚àû =
sup
Œ£‚àí1/2 (x u) G‚àû (x) ‚àí Z‚àû (u) 
{x‚ààX :(x)=‚àóŒº (u)}

5

Here, we follow the set inference approach described in Chernozhukov, Kocatulum, and Menzel (2015),
which builds on Chernozhukov, Hong, and Tamer (2007). In addition, our results justify the use of subsamplingbased methods as in Chernozhukov, Hong, and Tamer (2007) and Romano and Shaikh (2010).
6
Note that we can also similarly construct an inner confidence region, which is the complement of the outer
confidence region of X \ M‚àíu ; see Chernozhukov, Kocatulum, and Menzel (2015) for relevant discussion.

THE SORTED EFFECTS METHOD

1923

and x ‚Üí Œ£(x u) is a uniformly consistent estimator of x ‚Üí Œ£(x u), the variance function of the process G‚àû (x) ‚àí Z‚àû (u) defined in Section 4. The estimator c(1 ‚àí Œ±) can be
obtained as the (1 ‚àí Œ±)-quantile of the bootstrap version of V‚àû ,
V‚àû‚àó =

sup
{x‚ààX :(x)=‚àóŒº (u)}

 

‚àö 
‚àó (u) ‚àí (x) ‚àí ‚àó (u) 
Œ£‚àí1/2 (x u) n 
(x) ‚àí 
Œº
Œº

‚àó (u) are defined as in Algorithm 2.1. A similar (1 ‚àí Œ±)-confidence
where 
(x) and 
Œº
+u
set, CM (1 ‚àí Œ±), can be constructed for M+u . These sets can be visualized by plotting
all two- or three-dimensional projections of their elements. We provide an example of
such plots in Section 3. An immediate consequence of the set inference results in Chernozhukov, Kocatulum, and Menzel (2015) and the results of this paper is the following
corollary:
COROLLARY 2.3‚ÄîInference on Most and Least Affected Subpopulations: The sets
CM‚àíu (1 ‚àí Œ±) and CM+u (1 ‚àí Œ±) cover M‚àíu and M+u with probability approaching 1 ‚àí Œ±,
and CM‚àíu (1 ‚àí‚àöŒ±) and CM+u (1 ‚àí Œ±) are consistent in the sense that they approach to M‚àíu
and M+u at a n-rate with respect to the Hausdorff distance.
3. EMPIRICAL ANALYSIS OF THE GENDER WAGE GAP
We report the main results of the application to the gender wage gap using data from
the U.S. March Supplement of the Current Population Survey (CPS) in 2015. In Appendix H of the Supplemental Material, we complement the analysis with supporting results from a simulation calibrated to this application. There, we find that our estimation
and inference methods perform well in finite samples that closely mimic the characteristics of the CPS data. This exercise serves to indirectly verify the plausibility of the main
regularity conditions mentioned in Section 2 and formally stated in Section 4.
Our sample consists of white, non-Hispanic individuals who are aged 25 to 64 years
and work more than 35 hours per week during at least 50 weeks of the year. We exclude
self-employed workers; individuals living in group quarters; individuals in the military,
agricultural, or private household sectors; individuals with inconsistent reports on earnings and employment status; individuals with allocated or missing information in any of
the variables used in the analysis; and individuals with hourly wage rate below $3. The
resulting sample contains 32,523 workers including 18,137 men and 14,382 women.
We estimate interactive linear models with additive and non-additive errors, using mean
and quantile regressions, respectively. The outcome variable Y is the logarithm of the
hourly wage rate constructed as the ratio of the annual earnings to the total number of
hours worked, which is constructed in turn as the product of number of weeks worked and
the usual number of hours worked per week. The key covariate T is an indicator for female worker, and the control variables W include five marital status indicators (widowed,
divorced, separated, never married, and married); five educational attainment indicators
(less than high school graduate, high school graduate, some college, college graduate, and
advanced degree); four region indicators (midwest, south, west, and northeast); a quartic in potential experience constructed as the maximum of age minus years of schooling
minus 7 and zero, that is, experience = max(age ‚àí education ‚àí 7 0); five occupation indicators (management, professional, and related; service; sales and office; natural resources,
construction, and maintenance; and production, transportation, and material moving);

1924

V. CHERNOZHUKOV, I. FERN√ÅNDEZ-VAL, AND Y. LUO
TABLE I
DESCRIPTIVE STATISTICS OF WORKERSa

Log wage
Female
MS.married
MS.widowed
MS.separated
MS.divorced
MS.Nevermarried
E.lhs
E.hsg
E.sc
E.cg
E.ad
R.northeast
R.midwest
R.south
R.west
Experience

All

Women

Men

315
044
065
001
002
013
019
002
025
028
028
016
019
027
035
018
2168

302
100
061
002
002
016
018
002
021
029
030
018
019
028
035
018
2172

325
000
068
001
002
010
020
003
028
027
027
015
019
027
035
019
2165

O.manager
O.service
O.sales
O.construction
O.production
I.minery
I.construction
I.manufacture
I.retail
I.transport
I.information
I.finance
I.professional
I.education
I.leisure
I.services
I.public

All

Women

Men

0.48
0.10
0.23
0.09
0.11
0.03
0.06
0.14
0.13
0.04
0.02
0.08
0.11
0.24
0.05
0.03
0.07

0.55
0.10
0.31
0.01
0.04
0.01
0.01
0.08
0.11
0.02
0.02
0.10
0.10
0.40
0.05
0.03
0.06

0.43
0.09
0.16
0.15
0.17
0.04
0.09
0.18
0.14
0.06
0.03
0.07
0.13
0.11
0.04
0.04
0.07

a Source: March Supplement CPS 2015.

12 industry indicators (mining, quarrying, and oil and gas extraction; construction; manufacturing; wholesale and retail trade; transportation and utilities; information; financial services; professional and business services; education and health services; leisure
and hospitality; other services; and public administration); and all the two-way interactions between the education, experience, occupation, and industry variables except for
the occupation-industry interactions.7 All calculations use the CPS sampling weights to
account for non-random sampling in the March CPS.
Table I reports sample means of the variables used in the analysis. Working women
are more highly educated than working men, have about the same potential experience,
and are less likely to be married and more likely to be divorced. They work relatively
more often in managerial and sales occupations and in the industries providing education
and health services. Working men are relatively more likely to work in construction and
production occupations within non-service industries. The unconditional gender wage gap
is 23%.
Figure 1 of Section 1 plots estimates and 90% confidence bands for the APE and
SPE-function on the treated (women) of the conditional gender wage gap using additive and non-additive error models. The PEs are obtained as described in Examples 2
and 3 with P(T W ) = (T W  (1 ‚àí T )W ). In this case, dim P(T W ) = 332, which makes
it very difficult to identify any pattern about the gender wage gap just by looking at the
regression coefficients. The distribution FTW is estimated by the empirical distribution
of (T W ) for women, and F is approximated by a uniform distribution over the grid
{002 003     098}. The confidence bands are constructed using Algorithm 2.1 with
standard exponential weights (weighted bootstrap) and B = 500, and are uniform for
7

The sample selection criteria and the variable construction follow Mulligan and Rubinstein (2008). The occupation and industry categories follow the 2010 Census Occupational Classification and 2012 Census Industry
Classification, respectively.

1925

THE SORTED EFFECTS METHOD
TABLE II

CLASSIFICATION TABLE‚ÄîAVERAGE CHARACTERISTICS OF THE 10% LEAST AND MOST AFFECTED WOMEN
BY GENDER WAGE GAPa
10% Least

Log wage
M.married
M.widowed
M.separated
M.divorced
M.nevermarried
E.lhs
E.hsg
E.sc
E.cg
E.ad
R.ne
R.mw
R.so
R.we
Experience

10% Most

Est.

S.E.

Est.

S.E.

308
028
002
002
015
052
001
008
015
037
039
024
026
031
019
1305

0.03
0.03
0.01
0.01
0.02
0.03
0.01
0.02
0.03
0.04
0.04
0.02
0.02
0.02
0.02
1.03

297
087
001
001
007
004
006
030
023
017
024
018
028
039
015
2632

0.03
0.02
0.01
0.00
0.02
0.01
0.01
0.04
0.04
0.03
0.03
0.02
0.02
0.03
0.02
0.75

10% Least

O.manager
O.service
O.sales
O.construction
O.production
I.minery
I.construction
I.manufacture
I.retail
I.transport
I.information
I.finance
I.professional
I.education
I.leisure
I.services
I.public

10% Most

Est.

S.E.

Est.

S.E.

0.67
0.08
0.19
0.02
0.03
0.01
0.02
0.02
0.06
0.01
0.04
0.03
0.06
0.46
0.10
0.09
0.09

0.04
0.02
0.03
0.01
0.01
0.01
0.01
0.01
0.02
0.01
0.01
0.02
0.02
0.04
0.03
0.02
0.02

0.38
0.10
0.42
0.01
0.09
0.02
0.02
0.11
0.19
0.04
0.05
0.09
0.04
0.33
0.01
0.01
0.08

0.04
0.02
0.04
0.00
0.02
0.01
0.01
0.02
0.03
0.01
0.01
0.03
0.02
0.04
0.01
0.01
0.02

a PE estimated from a linear conditional quantile model with interactions. Standard errors obtained by weighted bootstrap with
500 repetitions.

the SPE-function over the grid U = {002 003     098}. We monotonize the bands using the rearrangement method described in Remark 2.2, and implement the finite-sample
corrections described in Remark 2.3. After controlling for worker characteristics, the gender wage gap for women remains on average around 20%. More importantly, we uncover
a striking amount of heterogeneity, with the PE ranging between ‚àí65 and 40% in the
additive error model and between ‚àí14 and 54% in the non-additive error model.8
Table II shows the results of a classification analysis, exhibiting characteristics of women
that are most and least affected by the gender wage gap together with standard errors
obtained by weighted bootstrap. We focus here on the non-additive model, but the results
from the additive model are similar. Since the PE are predominantly negative, we define
the most affected as (X) < ‚àóŒº (u) and the least affected as (X) > ‚àóŒº (1‚àíu) to facilitate
the interpretation. According to this model, the 10% of the women most affected by the
gender wage gap on average earn lower wages, are much more likely to be married, much
less likely to be never married, have lower education, live in the South, possess much more
potential experience, are more likely to have sales and non-managerial occupations, and
work more often in manufacture and retail and less often in education industries than the
10% least affected women.
Table III tests if the differences found in Table II are statistically significant. It reports
p-values for the test of equality of means for most and least affected women. The first
p-value accounts for simultaneous inference on all variables within a given category. For
example, it accounts that we are conducting five tests corresponding to the five categories
of marital status. For the non-categorical variables log wage and experience, the p-values
8
In the 2016 version of the paper, we found similar patterns of heterogeneity using CPS 2012 data with a
specification that did not include occupation and industry indicators.

1926

V. CHERNOZHUKOV, I. FERN√ÅNDEZ-VAL, AND Y. LUO
TABLE III

CLASSIFICATION TABLE‚ÄîDIFFERENCE IN THE AVERAGE CHARACTERISTICS OF THE 10% MOST AND LEAST
AFFECTED WOMEN BY GENDER WAGE GAPa
Est.

Log wage
M.married
M.widowed
M.separated
M.divorced
M.nevermarried
E.lhs
E.hsg
E.sc
E.cg
E.ad
R.ne
R.mw
R.so
R.we
Experience

‚àí010
059
‚àí002
‚àí001
‚àí008
‚àí048
005
022
008
‚àí019
‚àí015
‚àí006
002
008
‚àí004
1327

S.E.

004
004
002
001
004
004
001
005
006
006
006
004
004
004
003
154

p-Val.1

jp-Val.2

003
000
093
089
046
000
001
000
070
001
007
035
095
023
069
000

070
000
100
100
086
000
017
000
100
016
046
099
100
097
100
000

Est.

O.manager
O.service
O.sales
O.construction
O.production
I.minery
I.construction
I.manufacture
I.retail
I.transport
I.information
I.finance
I.professional
I.education
I.leisure
I.services
I.public

‚àí029
002
022
‚àí001
006
001
‚àí000
008
012
004
001
006
‚àí001
‚àí013
‚àí009
‚àí007
‚àí001

S.E.

006
003
006
001
002
001
001
002
004
001
002
004
003
006
003
002
003

p-Val.1

jp-Val.2

000
099
000
067
008
097
100
002
006
008
100
078
100
029
004
002
100

000
100
003
100
042
100
100
015
032
039
100
099
100
074
022
015
100

a PE estimated from a linear conditional quantile model with interactions. Standard errors and p-values obtained by weighted
bootstrap with 500 repetitions.
1 These p-values are adjusted for multiplicity to account for joint testing of zero coefficients on all the variables within a category:
M E, R, O, or I.
2 These p-values are adjusted for multiplicity to account for joint testing of zero coefficients on all the variables in the table.

are for one test. The second p-value accounts for simultaneous inference of all the differences displayed in the table.9 These p-values are obtained by Algorithm 2.2 with the appropriate choice of vectors of linear combinations and set T , and 500 weighted bootstrap
repetitions. The p-values show that most of the differences from Table II are statistically
significant at conventional significant levels after controlling for simultaneous inference.
In particular, the most affected women are significantly more likely to be married, highschool graduates, more experienced, and in sales occupations, and less likely to be never
married and in managerial occupations under the most strict simultaneous inference correction. Blau and Kahn (2017) have recently documented the importance of differences in
occupation and industry to explain the gender wage gap using data from the Panel Study
of Income Dynamics (PSID) 1980‚Äì2010 and a different methodology based on wage decompositions. Consistent with our findings, they argued that this importance might be
due to compensating differentials. Unlike Blau and Kahn (2017) and previous studies in
the literature, our analysis uncovers significant heterogeneity in the extent of the gender
wage gap and relates this heterogeneity to human capital, occupation, industry, and other
characteristics.
We further explore these findings by analyzing the APE and SPE on the treated conditional on marital status and unobserved rank in the non-additive error model. Figures 2
and 3 show estimates and 90% confidence bands of the APE and SPE-function of the
gender wage gap for two subpopulations defined by marital status (married and never
9

We employ the so-called ‚Äúsingle-step‚Äù methods for controlling the family-wise error rate. To generate a
(somewhat) higher power, we recommend to employ the p-values generated via ‚Äústep-down‚Äù methods, such
as those reported in Romano and Wolf (2016) and List, Shaikh, and Xu (2016).

THE SORTED EFFECTS METHOD

1927

FIGURE 2.‚ÄîAPE and SPE of the gender wage gap for women by marital status. Estimates and 90% bootstrap uniform confidence bands for the conditional quantile function.

married) and three subpopulations defined by unobserved rank (first decile, median, and
ninth decile, where the unobserved rank is 0.1, 0.5, and 0.9, respectively). The confidence
bands are constructed as in Figure 1. We find significant heterogeneity in the gender gap
within each subpopulation, and also between subpopulations defined by marital status and
unobserved rank. The SPE-function is more negative for married women and at the tails
of the conditional distribution. Married women at the top decile suffer from the highest
gender wage gaps. This pattern is consistent with ‚Äúglass-ceiling‚Äù effects behind the gender
wage gap (Albrecht, Bjorklund, and Vroman (2003)).

FIGURE 3.‚ÄîAPE and SPE of the gender wage gap for women by unobserved ranking in the conditional
distribution. Estimates and 90% bootstrap uniform confidence bands for the conditional quantile function.

1928

V. CHERNOZHUKOV, I. FERN√ÅNDEZ-VAL, AND Y. LUO

FIGURE 4.‚ÄîEstimates and 90% weighted bootstrap joint uniform confidence bands for the distributions of
experience and log wages of the 10% most and least affected women by gender wage gap.

Figure 4 plots simultaneous 90% confidence bands for the distribution of experience
and log wage for the most and least affected women. They are obtained by Algorithm
2.2 with 500 weighted bootstrap replications. The estimated distribution of experience for
the most affected first-order stochastically dominates the same estimated distribution for
the least affected women. Moreover, the uniform bands confirm that this dominance is
statistically significant at the 90% confidence level for the underlying distributions. The
estimated (marginal) distribution of log wage for the least affected first-order dominates
the same estimated distribution for most affected, but we cannot reject that the underlying distributions are equal at the 10% significance level. The results of the classification
analysis are consistent with preferences that make never married highly educated young
women working on managerial occupations be more career-oriented.10
Finally, Figure 5 plots two-dimensional projections of experience-log wage and
experience-marital status of the confidence sets for the 10% most and least affected
subpopulations. We show the results from the additive error model for the conditional
expectation. Here, we use a simplified specification that excludes the two-way interactions from W to get more precise estimates of all the PEs. We obtain 90% confidence sets
for the most and least affected subpopulations by weighted bootstrap with standard exponential weights and 500 repetitions. The sets CM‚àí01 (090) and CM+01 (090) include
23% and 19% of the women in the sample, respectively.11 The projections show that there
are relatively more least affected women with low experience at all wage levels, more high
affected women with high wages with between 15 and 25 years of experience, and more
least affected women who are not married at all experience levels.

10

We find similar results using the additive error model. We do not report these results for the sake of
brevity.
11
Recall that in this application, the set CM‚àí01 (090) corresponds to most affected women and
CM+01 (090) to least affected women. We drop one woman that is included in both sets.

THE SORTED EFFECTS METHOD

1929

FIGURE 5.‚ÄîEstimates and 90% weighted bootstrap confidence bands for projections of the confidence sets
for characteristics of 10% most and least affected women by gender wage gap.

4. DETAILED LARGE SAMPLE THEORY
4.1. Detailed Large Sample Theory for SPE
For an open set K, let the class C 1 on K denote the set of continuously differentiable
real-valued functions on K. We make the following technical assumptions about the PE
function  : Rdx ‚Üí R and the distribution of the covariates:
S1. The part of the domain of the PE function x ‚Üí (x) of interest, X , is open and
its closure X is compact. The distribution Œº is absolutely continuous with respect to the
Lebesgue measure with density Œº . There exists an open set B(X ) containing X such that
x ‚Üí (x) is C 1 on B(X ), and x ‚Üí Œº (x) is continuous on B(X ) and is zero outside the
domain of interest, that is, Œº (x) = 0 for any x ‚àà B(X ) \ X .
S2. Let M (Œ¥) := {x ‚àà X : (x) = Œ¥}. For any regular value Œ¥ of  on X , we assume
that the closure of M (Œ¥) has a finite number of connected branches.
The following property of the set M (Œ¥) is a useful implication of Assumptions S1 and
S2 that we will exploit in the analysis.
REMARK 4.1‚ÄîProperties of M (Œ¥): By Theorem 5-1 in Spivak (1965), p. 111, Assumptions S1 and S2 imply that M (Œ¥) is a (dx ‚àí 1)-manifold without boundary in Rdx
of class C 1 for any Œ¥ that is a regular value of x ‚Üí (x) on X .
Assumption S1 imposes mild smoothness conditions on the PE function x ‚Üí (x).
It also requires that all the components of the covariate X are continuous random variables. We defer the treatment of the case where X has both continuous and discrete
components to the Supplemental Material. As a matter of generalization, our theoretical
analysis allows us to replace that x ‚Üí Œº (x) vanishes on ‚àÇX , by the weaker condition that
the intersection of M (Œ¥) and ‚àÇX have zero volume with respect to Œº, namely,

Œº (x)
 dVol = 0
(4.1)
1{x ‚àà ‚àÇX } 


‚àÇ(x)
M (Œ¥)


1930

V. CHERNOZHUKOV, I. FERN√ÅNDEZ-VAL, AND Y. LUO

where ‚àÇX denotes the boundary of X , ‚àÇ(x) is the gradient of x ‚Üí (x), and
f (x) dVol denotes the integral of the function f on the manifold M with respect
M
to volume; see Appendix D in the Supplemental Material for a brief review on Differential Geometry. This relaxation is relevant to cover the case where X includes a uniformly
distributed component such as the unobserved rank in Example 3.12
Assumption S2 imposes shape restrictions on x ‚Üí (x) that rule out cases such as
infinite cyclical oscillations or flat areas. A simple sufficient condition for Assumption S2
is that the map x ‚Üí (x) does not have critical points on X . This means that x ‚Üí (x)
is not locally flat anywhere on X , which we define to mean that the norm of the gradient,
‚àÇ(x), does not vanish on x ‚àà X . In this case, any Œ¥ in the image of X under  is
regular. This condition is probably the most relevant for practice and can be verified in
applications, at least informally.
REMARK 4.2‚ÄîVerification of Regularity Conditions in Practice: The main regularity
condition is that PE function x ‚Üí (x) be smooth and not locally flat, namely, ‚àÇ(x)
does not vanish. Our inferential results are developed under this assumption, and they
do not apply otherwise. To verify if these results apply in practice, we strongly recommend to conduct a Monte Carlo experiment using a data generating process that mimics
the application at hand.13 Indeed, failure of the inference method in the simulation experiment implies failure of the regularity conditions. We provide an application of this
supporting analysis to the gender wage gap example in Appendix H. Looking forward, it
would be useful to develop further an inference method with good robustness properties
with respect to the regularity conditions, that is, that remains uniformly valid when the PE
function is (close to being) locally flat. We delegate this line of research to future work.14
We make the following assumptions about the estimator of the PE. Let ‚àû (T ) denote
the set of bounded and measurable functions g : T ‚Üí R and F a fixed subset of continuous functions on B(X ). Let ‚àû (B(X )) be the set of bounded and measurable functions
on B(X ) and  denote weak convergence (convergence in distribution).
S3. , the estimator of , belongs to F with probability approaching 1 and obeys a
functional central limit theorem, namely,
an ( ‚àí )  G‚àû

in

‚àû




B(X ) 

where an is a sequence such that an ‚Üí ‚àû as n ‚Üí ‚àû, and x ‚Üí G‚àû (x) is a tight process
that has almost surely uniformly continuous sample paths on B(X ).
In the parametric and semiparametric models of Examples 1‚Äì3, Assumption S3 holds
under weak conditions that guarantee asymptotic normality of the ML, OLS, and QR
estimators. For the QR estimator in Example 3 where the unobserved rank is one of the
covariates, these conditions include that the density of Y conditional on X be bounded
away from zero (Koenker (2005)), which is facilitated by excluding tail quantile indexes.
12
In the numerical examples of Appendix H in the Supplemental Material, the first two designs only satisfy
this relaxed condition.
13
In fact, we recommend doing this for every econometric method.
14
For instance, it is of interest to determine whether the use of subsampling instead of bootstrap can deliver
a more robust inference method when the PE function is close to being flat; see, for example, Romano and
Shaikh (2012).

THE SORTED EFFECTS METHOD

1931

Let Œº be the estimator of the distribution Œº. It is convenient to identify Œº and Œº with
the operators:


g ‚Üí Œº(g) = g(x) dŒº(x)
g‚Üí
 Œº(g) = g(x) d Œº(x)
mapping from the set G := {x ‚Üí 1(f (x) ‚â§ Œ¥) : f ‚àà F  Œ¥ ‚àà V } to R, where F is the fixed
subset of continuous functions on B(X ) containing , and V is any compact set of R. We
require G to be totally bounded under the L2 (Œº) norm. Define H as the set of all bounded
linear operators H on G of the form
g ‚Üí H(g)
which are uniformly continuous on g ‚àà G under the L2 (Œº) norm. We define the boundedness of these operators with respect to the norm:


HG = sup H(g)
g‚ààG

 in H as H ‚àí
and define the corresponding distance between two operators H and H


HG = supg‚ààG |H(g) ‚àí H(g)|. Clearly, Œº ‚àà H.
We make the following assumption about Œº.
S4. The function x ‚Üí Œº(x) is a distribution over B(X ) obeying in H,
bn (Œº ‚àí Œº)  H‚àû 

(4.2)

where g ‚Üí H‚àû (g) is a.s. an element of H (i.e., it has almost surely uniformly continuous
sample paths on G with respect to the L2 (Œº) metric) and bn is a sequence such that bn ‚Üí
‚àû as n ‚Üí ‚àû.
When Œº is the empirical distribution
‚àö based on a random sample from the population with distribution Œº, then bn = n and H‚àû = BŒº , where BŒº is a Œº-Brownian
Bridge, that is, a Gaussian process with zero mean and covariance function (g1  g2 ) ‚Üí
Œº(g1 g2 ) ‚àí Œº(g1 )Œº(g2 ). In this case, Assumption S4 imposes that the function class




G = x ‚Üí 1 f (x) ‚â§ Œ¥ : f ‚àà F  Œ¥ ‚àà V
is Œº-Donsker. Note that F is the parameter space that contains (x) as well as (x) in Assumption S3. In parametric models for the PE where F = {f (x Œ∏) : Œ∏ ‚àà Œò}, f is known,
Œ∏ ‚äÜ RdŒ∏ with dŒ∏ < ‚àû, and x ‚Üí f (x Œ∏) is C 1 on X for all Œ∏ ‚àà Œò, the class G is Œº-Donsker
under mild conditions specified, for example, in (van der Vaart, 1998, Chapter 19). Examples 1 and 2 specify the PE parametrically. Lemma F.1 in the Supplemental Material
gives other sufficient conditions for the Donsker property.
The following result is derived as a consequence of the new mathematical results on the
Hadamard differentiability of the sorting operator, stated in Lemma A.2 in the Appendix
(proof given in Supplemental Material due to space constraints), in conjunction with the
functional delta method. It shows that the empirical SPE-function follows a FCLT over
sets of quantiles corresponding to ‚àóŒº pre-images of compact sets of R.
u‚àà
Define D as a compact set consisting of regular values of x ‚Üí (x) on X , and U := {
u) ‚àà D  fŒº (‚àóŒº (
u)) > Œµ}, for a fixed Œµ > 0, where fŒº (‚àóŒº (
u)) is the density of
[0 1] : ‚àóŒº (
(X) defined in Lemma A.1(a). Let rn := an ‚àß bn , the slowest of the rates of convergence
of  and Œº. Assume rn /an ‚Üí s ‚àà [0 1] and rn /bn ‚Üí sŒº ‚àà [0 1], where s = 0 when bn =
o(an ) and sŒº = 0 when an = o(bn ). For example, sŒº = 0 if Œº is treated as known.

1932

V. CHERNOZHUKOV, I. FERN√ÅNDEZ-VAL, AND Y. LUO

THEOREM 4.1‚ÄîFCLT for FŒº and ‚àóŒº : Suppose that Assumptions S1‚ÄìS4 hold, and the
convergence in Assumptions S3 and S4 holds jointly. Then, as n ‚Üí ‚àû,
(a) The estimator of the distribution of PE obeys a functional central limit theorem, namely,
in ‚àû (D ),


rn FŒº (Œ¥) ‚àí FŒº (Œ¥)  s T‚àû (Œ¥) + sŒº H‚àû (gŒ¥ )
as a stochastic process indexed by Œ¥ ‚àà D , where

G‚àû (x)Œº (x)

 dVol
T‚àû (Œ¥) := ‚àí
‚àÇ(x)
M (Œ¥)


(b) The empirical SPE-process obeys a functional central limit theorem, namely, in

 ‚àó
s
T
(u)
+ sŒº H‚àû (g‚àóŒº (u) )


 ‚àó

‚àû
Œº

rn Œº (u) ‚àí ‚àóŒº (u)  ‚àí
=: Z‚àû (u)
Œº (x)

 dVol
‚àÇ(x)

‚àû

(U ),

(4.3)

as a stochastic process indexed by u ‚àà U .
REMARK 4.3‚ÄîCritical Values: (a) Theorem 4.1 shows that Œ¥ ‚Üí FŒº (Œ¥) (u ‚Üí ‚àóŒº (u))
follows a FCLT over any compact set D (the ‚àóŒº pre-image of D ), where D excludes the
critical values of x ‚Üí (x) on X . Thus, we can set D = (X ) := {(x) : x ‚àà X } when the
map x ‚Üí (x) does not have critical points on X . This case is nice because it allows us
not to worry about critical values when performing inference, and practically relevant as it
occurs very naturally in many applications. For instance, it arises whenever (x) is strictly
locally monotonic in some direction. (b) In numerical examples reported in the Supplemental Material, we find that the bootstrap inference method proposed performs well
even in models where x ‚Üí (x) has critical points, without excluding the corresponding
critical values from D . This evidence suggests that the exclusion of critical values might
not be necessary for inference.
4.2. Detailed Large Sample Theory for CA
It is convenient to modify the notation for the u-CA separating the dependence
on ‚àóŒº (u) from  and Œº and specifying the characteristic of interest as œït . Moreover, when Z = (X Y ), we remove the dependence on Y by taking expectations
conditional on X. Let ŒõŒº‚àóŒº (u) (œït ) := ŒõuŒº (t) and ŒõŒº‚àóŒº (u) (œït ) := ŒõuŒº (t), where
 t
t
œït ‚àà FM ‚à™ FI , t = (t1      tdz ) ‚àà Rdz , u ‚àà U , FM := { z11 ¬∑ ¬∑ ¬∑ zddzz dŒº(y | x) : t1      tdz ‚àà
 t1
tdz
{0 1 2   } |z1 ¬∑ ¬∑ ¬∑ zdz | dŒº(z) < ‚àû t1 + ¬∑ ¬∑ ¬∑ + tdz ‚â§ M}, M is some fixed integer, Œº(y | x)
is the distribution of Y at y conditional on X = x, and FI := { 1(z1 ‚â§ t1      zdz ‚â§
tdz ) dŒº(y | x) : t1      tdz ‚àà R}. For example, œït (x) = xtx E[Y ty | X = x] or œït (x) = 1(x ‚â§
tx )Œº(ty | x) for t = (tx  ty ). To derive the properties of ŒõŒº‚àóŒº (u) (œït ), we use that the
 = {1(f ‚â§ Œ¥)œï : œï ‚àà FM ‚à™ FI  Œ¥ ‚àà V  f ‚àà F } is Œº-Donsker. When
class of functions G
x ‚Üí Œº(y | x) is continuous, this property holds by Assumption S4 when Œº is the empirical distribution.15
15

Lemma F.2 in the Supplemental Material gives other sufficient conditions for the Donsker property.

THE SORTED EFFECTS METHOD

1933

The following result is derived as a consequence of the new mathematical results on
the Hadamard differentiability of the classification operator, stated in Lemma A.3 in the
Appendix (proof given in Supplemental Material due to space constraints), in conjunction
with the functional delta method.
THEOREM 4.2‚ÄîFCLT for ŒõŒº‚àóŒº (u) (œït ): Suppose that Assumptions S1‚ÄìS4 hold, the
convergence in Assumptions S3 and S4 holds jointly, and u ‚àà U . If Z = (X Y ), then assume that Y is compact and x ‚Üí Œº(y | x) is continuous on B(X ) for all y ‚àà Y . Then, as
n ‚Üí ‚àû, (a) ŒõŒº‚àóŒº (u) (œït ) obeys a FCLT with respect to t ‚Üí œït ‚àà FM , namely, in ‚àû (Rdz )2 ,


rn ŒõŒº‚àóŒº (u) (œït ) ‚àí ŒõŒº‚àóŒº (u) (œït )

Z‚àû (u) ‚àí s G‚àû (x)
u

Œº (x) dVol + sŒº H‚àû (
œï
t (x)
hŒ¥œït ) =: Z‚àû
(t)
‚àÇ(x)
M (Œ¥)
t (x) = [œït (x) ‚àí ŒõŒºŒ¥ (œït )]/FŒº (Œ¥),
as a stochastic process indexed by t ‚àà Rdz , where œï

t (x)1{(x) ‚â§ Œ¥}, and Z‚àû (u) is the limit process of Theorem 4.1; and (b) if, in
hŒ¥œït := œï
addition, Assumption AS1 holds, then ŒõŒº‚àóŒº (u) (œït ) obeys the same FCLT with respect to
t ‚Üí œït ‚àà FI .
Assumption AS1 is a technical condition stated in Appendix E of the Supplemental
Material to deal with the discontinuity of the indicator functions when œït ‚àà FI . A sufficient condition for Assumption AS1 is that

dVol = 0
M (Œ¥)‚à©{x:xk =tk }

holds uniformly over all Œ¥ ‚àà V , tk ‚àà R, and k = 1 2     dx . In other words, the manifold
M (Œ¥) and the set of points {x : xk = tk } cannot have an intersection with positive volume
of (dx ‚àí 1)-dimension.
4.3. Bootstrap Inference for SPE and CA
Corollaries 2.1 and 2.2 use critical values of statistics related to the limit processes Z‚àû
u
and Z‚àû
to construct confidence bands and p-values. These critical values can be hard
to obtain in practice. In principle, one can use simulation, but it might be difficult to
numerically locate and parameterize the manifold M (Œ¥), and to evaluate the integrals
u
(t). This creates a real
on M (Œ¥) needed to compute the realizations of Z‚àû (u) and Z‚àû
challenge to implement our inference methods. To deal with this challenge, we employ
(exchangeable) bootstrap to compute critical values (Pr√¶stgaard and Wellner (1993), van
der Vaart and Wellner (1996)) instead of simulation. We show that the bootstrap law is
consistent to approximate the distribution of the limit processes of Theorems 4.1 and 4.2.
To state the bootstrap validity result formally, we follow the notation and definitions in van der Vaart and Wellner (1996). Let Dn denote the data vector and let
n =
Bn = (œâ1      œân ) be the vector of bootstrap weights. Consider a random element Z
n consistently estiZn (Dn  Bn ) in a normed space D. We say that the bootstrap law of Z
n P Z‚àû if
mates the law of some tight random element Z‚àû and write Z


n ) ‚àí EP h(Z‚àû ) ‚ÜíP 0
sup EBn h(Z
h‚ààBL1 (D)

1934

V. CHERNOZHUKOV, I. FERN√ÅNDEZ-VAL, AND Y. LUO

where BL1 (D) denotes the space of functions with Lipschitz norm at most 1; EBn denotes
the conditional expectation with respect to Bn given the data Dn ; EP denotes the expectation with respect to P, the distribution of the data Dn ; and ‚ÜíP denotes convergence in
(outer) probability.
The next result is a consequence of the functional delta method for the exchangeable
u (t), the bootstrap draw of Œõu (t) defined in Algobootstrap. Let ŒõŒº‚àóŒº (u) (œït ) := Œõ
Œº
Œº
rithm 2.2.
THEOREM 4.3‚ÄîBootstrap FCLT for ‚àóŒº and ŒõŒº‚àóŒº (u) (œït ): Suppose that the bootstrap
is consistent for the law of the estimator of the PE, namely, an (
 ‚àí ) P G‚àû in ‚àû (B(X )),
Œº ‚àí Œº) P H‚àû in H. Then, (1) under
and for the law of the estimated measure, namely, bn (
the assumptions of Theorem 4.1, the bootstrap is consistent for the law of the empirical SPEprocess, namely,


‚àó (u) ‚àí ‚àó (u) P Z‚àû (u) in ‚àû (U );
rn 
Œº
Œº
and (2) under the assumptions of Theorem 4.2, the bootstrap is consistent for the law of the
empirical CA-process, namely,


u
(t) in
rn ŒõŒº‚àóŒº (u) (œït ) ‚àí ŒõŒº‚àóŒº (u) (œït )  Z‚àû

‚àû



2
Rdz 

Theorem 4.3 employs the high-level condition that the bootstrap can approximate consistently the laws of  and Œº, after suitable rescaling. In Examples 1‚Äì3 when Œº is the
empirical measure based on the random sample of size n, the exchangeable bootstrap
method entails randomly reweighing the sample using the weights (œâ1      œân ), which
include empirical bootstrap and i.i.d. exponential weights, for example. In this case, the
high-level condition holds if the weights satisfy the conditions stated in equation (3.6.8)
of van der Vaart and Wellner (1996). We refer to van der Vaart and Wellner (1996) and
Chernozhukov, Fern√°ndez-Val, and Melly (2013) for bootstrap FCLT for parametric and
semiparametric estimators of  including least squares, quantile regression, and distribution regression, as well as nonparametric estimators of Œº including the empirical distribution function.
APPENDIX A: KEY NEW MATHEMATICAL RESULTS: HADAMARD DIFFERENTIABILITY
OF SORTING AND CLASSIFICATION OPERATORS
A.1. Notation
We denote the PE as (x), the empirical PE as (x), and ‚àÇ(x) := ‚àÇ(x)/‚àÇx, the
dv
gradient of x ‚Üí (x). For
‚àö a vector v = (v1      vdv )T ‚àà R , v denotes the Euclidean
norm of v, that is, v = vT v, where the superscript denotes transpose.
A.2. Basic Analytical Properties of Sorted Functions
The following lemma establishes the properties of the distribution function Œ¥ ‚Üí FŒº (Œ¥)
and the SPE-function u ‚Üí ‚àóŒº (u).
Define D as a compact set consisting of regular values of x ‚Üí (x) on X .
LEMMA A.1‚ÄîBasic Properties of FŒº and ‚àóŒº : Under Assumptions S1 and S2:

1935

THE SORTED EFFECTS METHOD

1. For any Œ¥ ‚àà D , the derivative of FŒº (Œ¥) with respect to Œ¥ is

Œº (x)

 dVol
fŒº (Œ¥) := ‚àÇŒ¥ FŒº (Œ¥) =


M (Œ¥) ‚àÇ(x)

(A.1)

This integral is well-defined because the gradient x ‚Üí ‚àÇ(x) is finite, continuous, and
bounded away from 0 on M (Œ¥) ‚äÜ X . The map Œ¥ ‚Üí fŒº (Œ¥) is uniformly continuous on D .
2. Fix Œµ > 0; then, for any u ‚àà U := {
u ‚àà [0 1] : ‚àóŒº (
u) ‚àà D  fŒº (‚àóŒº (
u)) > Œµ}, the deriva‚àó
tive of Œº (u) with respect to u is
‚àÇu ‚àóŒº (u) =

fŒº

1

‚àóŒº (u)



(A.2)

Moreover, the derivative map u ‚Üí ‚àÇu ‚àóŒº (u) is uniformly continuous on U .
A.3. Functional Derivatives of Sorting-Related Operators
We consider the properties of the distribution function and the SPE-function as functional operators ( Œº) ‚Üí FŒº and ( Œº) ‚Üí ‚àóŒº . We show that these operators are
Hadamard differentiable with respect to ( Œº). These results are critical ingredients to
deriving the large sample distributions of the empirical versions of FŒº and ‚àóŒº in Section 4.
We now recall the definition of uniform Hadamard differentiability from van der Vaart
and Wellner (1996).
DEFINITION A.1‚ÄîHadamard Derivative Uniformly in an Index: Suppose the linear
spaces D and E are equipped with the norms  ¬∑ D and  ¬∑ E , and Œò is a compact subset
of a metric space. A map œÜŒ∏ : DœÜ ‚äÜ D ‚Üí E is called Hadamard differentiable uniformly
in Œ∏ ‚àà Œò at f ‚àà DœÜ tangentially to a subspace D0 ‚äÜ D if there is a continuous linear map
‚àÇf œÜŒ∏ : D0 ‚Üí E such that, uniformly in Œ∏ ‚àà Œò,
œÜŒ∏ (f + tn hn ) ‚àí œÜŒ∏ (f )
‚àí ‚àÇf œÜŒ∏ [h] ‚Üí 0
tn

n ‚Üí ‚àû

(A.3)

for all converging real sequences tn ‚Üí 0 and hn ‚àí hD ‚Üí 0 such that f + tn hn ‚àà DœÜ for
every n, and h ‚àà D0 ; moreover, the map (Œ∏ h) ‚Üí ‚àÇf œÜŒ∏ [h] is continuous on Œò √ó D0 .
In what follows, we let F denote the space of continuous functions on B(X ) equipped
with the sup-norm, and F0 denote a subset of F that contains uniformly continuous functions.
LEMMA A.2‚ÄîHadamard Differentiability of ( Œº) ‚Üí FŒº and ( Œº) ‚Üí ‚àóŒº : Let D :=
F √ó H and D0 := F0 √ó H. Assume that Assumptions S1‚ÄìS2 hold. Then,
(a) The map ( Œº) ‚Üí FŒº (Œ¥), mapping D ‚Üí R, is Hadamard differentiable uniformly in
Œ¥ ‚àà D at ( Œº) tangentially to D0 with the derivative map ‚àÇŒº FŒº (Œ¥) : D0 ‚Üí R defined by

G(x)Œº (x)

 dVol + H(gŒ¥ )
(G H) ‚Üí ‚àÇŒº FŒº (Œ¥)[G H] := ‚àí
‚àÇ(x)
M (Œ¥)


1936

V. CHERNOZHUKOV, I. FERN√ÅNDEZ-VAL, AND Y. LUO

(b) The map ( Œº) ‚Üí ‚àóŒº (u), mapping D ‚Üí R, is Hadamard differentiable uniformly in
u ‚àà U at ( Œº) tangentially to D0 with the derivative map, ‚àÇŒº ‚àóŒº (u) : D0 ‚Üí R, defined by


‚àÇŒº FŒº ‚àóŒº (u) [G H]
‚àó


(G H) ‚Üí ‚àÇŒº Œº (u)[G H] := ‚àí

fŒº ‚àóŒº (u)
A.4. Functional Derivatives of Classification Operators
 √ó R, where F and F0 are defined as before; H
 is


Let D := F √ó H √ó R and 
D0 := F0 √ó H

the set of bounded linear operators mapping from the set G := {œï1( ‚â§ Œ¥) : f ‚àà F  œï ‚àà
FI ‚à™ FM  Œ¥ ‚àà V } to R, with norm


HG = supH(g)

g‚ààG

 under the L2 (Œº) norm. We
where the map g ‚Üí H(g) is uniformly continuous on g ‚àà G
derive the properties of the least affected classification operator Œõ‚àíŒºŒ¥ : 
D ‚Üí R defined
by






‚àí
ŒõŒºŒ¥ (œït ) := œït (x)1 (x) ‚â§ Œ¥ dŒº(x)/ 1 (x) ‚â§ Œ¥ dŒº(x)
where œït ‚àà FM for moments and œït ‚àà FI for distributions of the components of Z, and
Œ¥ = ‚àóŒº (u) for some u ‚àà U . The properties of the most affected operator Œõ+ŒºŒ¥ : 
D‚ÜíR
can be derived using similar arguments, which are omitted for brevity.
LEMMA A.3‚ÄîHadamard Differentiability of ( Œº Œ¥) ‚Üí Œõ‚àíŒºŒ¥ : Assume that Assumptions S.1 and S.2 hold, Œ¥ ‚àà D , and FŒº (Œ¥) > 0. Then,
(a) The map Œõ‚àíŒºŒ¥ (œït ) : 
D ‚Üí R is Hadamard differentiable uniformly in œït ‚àà FM at
( Œº Œ¥) tangentially to 
D0 .
(b) If, in addition, Assumption AS1 stated in Appendix E of the Supplemental Material holds, the map Œõ‚àíŒºŒ¥ (œït ) : 
D ‚Üí R is Hadamard differentiable uniformly in œït ‚àà FI at
( Œº Œ¥) tangentially to 
D0 .
(c) The derivative map ‚àÇŒºŒ¥ Œõ‚àíŒºŒ¥ (œït ) : 
D ‚Üí R is defined by

K ‚àí G(x)
 dVol + H(
œï
t (x) 
(G H K) ‚Üí ‚àÇŒºŒ¥ Œõ‚àíŒºŒ¥ (œït )[G H K] :=
hŒ¥œït )
‚àÇ(x)
M (Œ¥)




where œï
t (x) = [œït (x) ‚àí Œõ‚àíŒºŒ¥ (œït )]/ 1((x) ‚â§ Œ¥) dŒº(x) and 
hŒ¥œït := œï
t (x)1{(x) ‚â§ Œ¥}.
APPENDIX B: PROOFS OF SECTION 4
We first recall Theorem 3.9.4 of van der Vaart and Wellner (1996).
LEMMA B.1‚ÄîDelta-method: Let D and E be metrizable topological vector spaces, and
Œò be a compact subset of a metric space. Let œÜŒ∏ : DœÜ ‚äÜ D ‚Üí E be a Hadamard differentiable mapping uniformly in Œ∏ ‚àà Œò at f ‚àà D tangentially to D0 ‚äÜ D, with derivative ‚àÇf œÜŒ∏ .
Let fn : Œ©n ‚Üí DœÜ be stochastic maps taking values in DœÜ such that rn (fn ‚àí f )  J‚àû for
some sequence of constants rn ‚Üí ‚àû, where J‚àû is separable and takes values in D0 . Then
rn (œÜŒ∏ (fn ) ‚àí œÜŒ∏ (f ))  ‚àÇf œÜŒ∏ [J‚àû ], as a stochastic process indexed by Œ∏ ‚àà Œò.

THE SORTED EFFECTS METHOD

1937

PROOF OF THEOREM 4.1: The statements follow directly from Lemma A.2, and Lemma B.1, by setting œÜŒ∏ = FŒº (Œ¥) with Œ∏ = Œ¥ or œÜŒ∏ = ‚àóŒº (u) with Œ∏ = u, DœÜ = D = F √ó H,
E = R, D0 = F0 √ó H, f = ( Œº), fn = ( Œº), and J‚àû = (s G‚àû  sŒº H‚àû ). The expression of
‚àÇf œÜŒ∏ for each statement is the Hadamard derivative in the corresponding statement of
Lemma A.2.
Q.E.D.
PROOF OF THEOREM 4.2: The statements follow directly from Lemma A.4, and Lem √ó R, E = R, D0 = F0 √ó H
 √ó R,
ma B.1, by setting œÜŒ∏ = Œõ‚àíŒºŒ¥ , Œ∏ = t, DœÜ = D = F √ó H
‚àó
‚àó
f = ( Œº Œº (u)), fn = ( Œº Œº (u)), and J‚àû = (s G‚àû  sŒº H‚àû  Z‚àû ). The expression of
‚àÇf œÜŒ∏ for each statement is the Hadamard derivative in the corresponding statement of
Lemma A.4.
Q.E.D.
To prove Theorem 4.3, we recall Theorem 3.9.11 of van der Vaart (1998). Here, we use
the notation for bootstrap convergence P defined in Section 4.3.
LEMMA B.2‚ÄîDelta-method for Bootstrap in Probability: Let D and E be metrizable
topological vector spaces, and Œò be a compact subset of a metric space. Let œÜŒ∏ : DœÜ ‚äÜ D ‚Üí
E be a Hadamard differentiable mapping uniformly in Œ∏ ‚àà Œò at f tangentially to D0 with
derivative ‚àÇf œÜŒ∏ . Let fn be a random element such that rn (fn ‚àí f )  J‚àû . Let fn be a stochastic
map in D, produced by a bootstrap method, such that rn (fn ‚àí fn ) P J‚àû . Then, rn (œÜŒ∏ (fn ) ‚àí
œÜŒ∏ (fn )) P ‚àÇf œÜŒ∏ [J‚àû ], as a stochastic process indexed by Œ∏ ‚àà Œò.
PROOF OF THEOREM 4.3: The statement (1) follows directly from Lemma A.2, and
Lemma B.2, by setting œÜŒ∏ = ‚àóŒº (u), Œ∏ = u, DœÜ = D = F √ó H, E = R, D0 = F0 √ó H, f =
( Œº), fn = ( Œº), and J‚àû = (s G‚àû  sŒº H‚àû ). The expression of ‚àÇf œÜŒ∏ is the Hadamard
derivative in statement (b) of Lemma A.2. The statement (2) follows directly from
 √ó R, E = R,
Lemma A.3, and Lemma B.2, by setting œÜŒ∏ = Œõ‚àíŒºŒ¥ , Œ∏ = t, DœÜ = D = F √ó H
‚àó

f = ( Œº Œº (u)), fn = ( Œº ‚àóŒº (u)), and J‚àû = (s G‚àû  sŒº H‚àû  Z‚àû ). The
D0 = F0 √ó H√óR,
expression of ‚àÇf œÜŒ∏ is the Hadamard derivative in statement (c) of Lemma A.3. Q.E.D.
REFERENCES
ALBRECHT, J., A. BJORKLUND, AND S. VROMAN (2003): ‚ÄúIs There a Glass Ceiling in Sweden?‚Äù Journal of
Labor Economics, 21 (1), 145‚Äì177.[1927]
ANGRIST, J. D., AND J.-S. PISCHKE (2008): Mostly Harmless Econometrics: An Empiricist‚Äôs Companion. Princeton university press.[1912]
BHATTACHARYA, D., AND P. DUPAS (2012): ‚ÄúInferring Welfare Maximizing Treatment Assignment Under Budget Constraints,‚Äù Journal of Econometrics, 167 (1), 168‚Äì196.[1917]
BLAU, F. D., AND L. M. KAHN (2017): ‚ÄúThe Gender Wage Gap: Extent, Trends, and Explanations,‚Äù Journal of
Economic Literature, 55 (3), 789‚Äì865.[1926]
CHERNOZHUKOV, V., I. FERN√ÅNDEZ-VAL, AND A. GALICHON (2009): ‚ÄúImproving Point and Interval Estimators of Monotone Functions by Rearrangement,‚Äù Biometrika, 96 (3), 559‚Äì575.[1920,1921]
(2010): ‚ÄúQuantile and Probability Curves Without Crossing,‚Äù Econometrica, 78 (3), 1093‚Äì1125.[1914]
CHERNOZHUKOV, V., I. FERNANDEZ-VAL, AND Y. LUO (2018): ‚ÄúSupplement to ‚ÄòThe Sorted Effects Method:
Discovering Heterogeneous Effects Beyond Their Averages‚Äô,‚Äù Econometrica Supplemental Material, 86,
https://doi.org/10.3982/ECTA14415. [1914]
CHERNOZHUKOV, V., I. FERN√ÅNDEZ-VAL, AND B. MELLY (2013): ‚ÄúInference on Counterfactual Distributions,‚Äù
Econometrica, 81 (6), 2205‚Äì2268.[1934]
CHERNOZHUKOV, V., H. HONG, AND E. TAMER (2007): ‚ÄúEstimation and Inference on Identified Parameter
Sets in Econometric Models,‚Äù Econometrica.[1922]

1938

V. CHERNOZHUKOV, I. FERN√ÅNDEZ-VAL, AND Y. LUO

CHERNOZHUKOV, V., E. KOCATULUM, AND K. MENZEL (2015): ‚ÄúInference on Sets in Finance,‚Äù Journal of
Economic Literature, 6 (2), 309‚Äì358.[1922,1923]
COX, D. R. (1984): ‚ÄúInteraction,‚Äù International Statistical Review, 52 (1), 1‚Äì31. With discussion and a reply by
the author.[1912]
HAUSMAN, J. A., AND W. K. NEWEY (2017): ‚ÄúNonparametric Welfare Analysis,‚Äù Annual Review of Economics,
9 (1), 521‚Äì546.[1917]
KIM, J., AND D. POLLARD (1990): ‚ÄúCube Root Asymptotics,‚Äù Annals of Statistics, 18 (1), 191‚Äì219.[1914]
KOENKER, R. (2005): Quantile Regression. Cambridge university press.[1930]
KOENKER, R., AND G. BASSET (1978): ‚ÄúRegression Quantiles,‚Äù Econometrica, 46 (1), 33‚Äì50.[1919]
LIST, J. A., A. M. SHAIKH, AND Y. XU (2016): ‚ÄúMultiple Hypothesis Testing in Experimental Economics,‚Äù
Discussion paper, National Bureau of Economic Research. [1921,1926]
MULLIGAN, C. B., AND Y. RUBINSTEIN (2008): ‚ÄúSelection, Investment, and Women‚Äôs Relative Wages Over
Time,‚Äù The Quarterly Journal of Economics, 123 (3), 1061‚Äì1110.[1924]
OAXACA, R. (1973): ‚ÄúMale-Female Wage Differentials in Urban Labor Markets,‚Äù International Economic Review, 14 (3), 693‚Äì709.[1912]
PR√ÜSTGAARD, J., AND J. A. WELLNER (1993): ‚ÄúExchangeably Weighted Bootstraps of the General Empirical
Process,‚Äù Annals of Probability, 21 (4), 2053‚Äì2086.[1933]
ROMANO, J. P., AND A. M. SHAIKH (2010): ‚ÄúInference for the Identified Set in Partially Identified Econometric
Models,‚Äù Econometrica, 78 (1), 169‚Äì211.[1922]
(2012): ‚ÄúOn the Uniform Asymptotic Validity of Subsampling and the Bootstrap,‚Äù Annals of Statistics,
40 (6), 2798‚Äì2822.[1930]
ROMANO, J. P., AND M. WOLF (2016): ‚ÄúEfficient Computation of Adjusted p-Values for Resampling-Based
Stepdown Multiple Testing,‚Äù Statistics & Probability Letters, 113, 38‚Äì40.[1926]
ROMANO, J. P., A. M. SHAIKH, AND M. WOLF (2010a): ‚ÄúHypothesis Testing in Econometrics,‚Äù Annual Review
of Economics, 2 (1), 75‚Äì104.[1921]
(2010b): ‚ÄúMultiple Testing,‚Äù in The New Palgrave Dictionary of Economics, ed. by S. N. Durlauf and
L. E. Blume. Basingstoke: Palgrave Macmillan.[1921]
ROSENBAUM, P. R., AND D. B. RUBIN (1983): ‚ÄúThe Central Role of the Propensity Score in Observational
Studies for Causal Effects,‚Äù Biometrika, 70 (1), 41‚Äì55.[1916]
SASAKI, Y. (2015): ‚ÄúWhat Do Quantile Regressions Identify for General Structural Functions?‚Äù Econometric
Theory, 31 (5), 1102‚Äì1116.[1914]
SPIVAK, M. (1965): Calculus on Manifolds. A Modern Approach to Classical Theorems of Advanced Calculus.
New York-Amsterdam: W. A. Benjamin, Inc.[1929]
VAN DER VAART, A. W. (1998): Asymptotic Statistics. Cambridge University Press.[1931,1937]
VAN DER VAART, A. W., AND J. A. WELLNER (1996): Weak Convergence and Empirical Processes. Springer
Series in Statistics.[1920,1933-1936]
WOOLDRIDGE, J. M. (2010): Econometric Analysis of Cross Section and Panel Data (Second Ed.). Cambridge,
Massachusetts: The MIT Press.[1912]

Co-editor Elie Tamer handled this manuscript.
Manuscript received 18 May, 2016; final version accepted 12 June, 2018; available online 25 July, 2018.

